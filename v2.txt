using Microsoft.Win32;
using mshtml;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Diagnostics;
using System.Drawing;
using System.Linq;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace WebBrowserTest
{
    public partial class Form1 : Form
    {
        static WebBrowser browser = new WebBrowser();

        public Form1()
        {
            InitializeComponent();
            //createRegistry();
            SuppressCookiePersistence();
            //browser.DocumentCompleted += browser_DocumentCompleted;
            //browser.ProgressChanged += InjectAlertBlocker;
            browser.Size = new Size(Width, Height);
            browser.ScriptErrorsSuppressed = true;
            browser.Navigate("https://login.yahoo.co.jp/config/login");

            this.Controls.Add(browser);
        }

        private static void SuppressCookiePersistence()
        {
            int flag = INTERNET_SUPPRESS_COOKIE_PERSIST;
            if (!InternetSetOption(IntPtr.Zero, INTERNET_OPTION_SUPPRESS_BEHAVIOR, ref flag, sizeof(int)))
            {
                var ex = Marshal.GetExceptionForHR(Marshal.GetHRForLastWin32Error());
                throw ex;
            }
        }

        const int INTERNET_OPTION_SUPPRESS_BEHAVIOR = 81;
        const int INTERNET_SUPPRESS_COOKIE_PERSIST = 3;

        [DllImport("wininet.dll", CharSet = CharSet.Auto, SetLastError = true)]
        public static extern bool InternetSetOption(IntPtr hInternet, int dwOption, ref int flag, int dwBufferLength);

        private static void InjectAlertBlocker(object sender, WebBrowserProgressChangedEventArgs e)
        {
            if (browser.ReadyState == WebBrowserReadyState.Complete)
            {
                HtmlElement scriptEl = browser.Document.CreateElement("script");
                IHTMLScriptElement element = (IHTMLScriptElement)scriptEl.DomElement;
                string alertBlocker = "window.alert = function (message) { }";
                element.text = alertBlocker;
                browser.Document.GetElementsByTagName("head")[0].AppendChild(scriptEl);
            }
        }

        static void browser_DocumentCompleted(object sender, WebBrowserDocumentCompletedEventArgs e)
        {
            //loaded the Yahoo login page
            if (browser.Url.AbsoluteUri.Equals("https://login.yahoo.co.jp/config/login"))
            {
                if (browser.Document != null)
                {
                    //Find and fill the "username" textbox
                    HtmlElementCollection collection = browser.Document.GetElementsByTagName("input");
                    foreach (HtmlElement element in collection)
                    {
                        string name = element.GetAttribute("id");
                        if (name == "username")
                        {
                            element.SetAttribute("value", "ksd523288");
                            break;
                        }
                    }

                    //Find and fill the "password" field
                    foreach (HtmlElement element in collection)
                    {
                        string name = element.GetAttribute("id");
                        if (name == "passwd")
                        {
                            element.SetAttribute("value", "Knight123");
                            break;
                        }
                    }

                    //Submit the form
                    //collection = browser.Document.GetElementsByTagName("button");
                    //foreach (HtmlElement element in collection)
                    //{
                    //    string name = element.GetAttribute("id");
                    //    if (name == "btnSubmit")
                    //    {
                    //        element.InvokeMember("Submit");
                    //        break;
                    //    }
                    //}
                    HtmlElement hidden = browser.Document.GetElementById(".done");
                    hidden.SetAttribute("value", "https://lohaco.jp");
                    HtmlElement form = browser.Document.GetElementById("login_form");
                    if (form != null)
                        form.InvokeMember("submit");
                }
            }
            if (browser.Url.AbsoluteUri.Equals("https://lohaco.jp/"))
            {
                browser.Navigate("https://lohaco.jp/odr/order/shoppingCartView");
            }
            if (browser.Url.AbsoluteUri.Equals("https://lohaco.jp/odr/order/shoppingCartView/"))
            {
                var collection = browser.Document.GetElementsByTagName("a");
                foreach (HtmlElement element in collection)
                {
                    string name = element.InnerText;
                    if (name != null && name.Contains("IDÇ≈ÉçÉOÉCÉìÇµÇƒíçï∂Ç∑ÇÈ"))
                    {
                        element.InvokeMember("onclick");
                        break;
                    }
                    if (name != null && name.Contains("íçï∂éËë±Ç´Ç÷"))
                    {
                        element.InvokeMember("onclick");
                        break;
                    }
                }
            }
            if (browser.Url.AbsoluteUri.Equals("https://lohaco.jp/odr/order/shoppingCart/orderProcess"))
            {
                var collection = browser.Document.GetElementsByTagName("a");
                foreach (HtmlElement element in collection)
                {
                    string name = element.InnerText;
                    if (name != null && name.Contains("éüÇ÷"))
                    {
                        element.InvokeMember("click");
                        break;
                    }
                }
            }
        }

        public static void createRegistry()
        {
            var filename = Process.GetCurrentProcess().MainModule.FileName;
            filename = filename.Substring(filename.LastIndexOf('\\') + 1,
                filename.Length - filename.LastIndexOf('\\') - 1);
            if (filename.Contains("vhost"))
                filename = filename.Substring(0, filename.IndexOf('.') + 1) + "exe";

            Debug.Assert(Registry.CurrentUser != null, "Registry.CurrentUser != null");

            RegistryKey key1 = Registry.CurrentUser.CreateSubKey(@"SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_BROWSER_EMULATION");
            RegistryKey key2 = Registry.CurrentUser.CreateSubKey(@"SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_BEHAVIORS");
            key1.SetValue(filename, 11001, RegistryValueKind.DWord);
            key2.SetValue(filename, 11001, RegistryValueKind.DWord);
            key1.Close();
            key2.Close();
        }
    }
}
